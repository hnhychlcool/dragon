<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="titan.wms.common.dao.mapper.inside.PlannedMoveTaskMapper">
    <!--auto generated Code-->
    <resultMap id="AllColumnMap" type="titan.wms.common.dao.meta.inside.PlannedMoveTaskDO">
        <result column="id" property="id"/>
        <result column="planned_move_order_id" property="plannedMoveOrderId"/>
        <result column="status" property="status"/>
        <result column="location_code" property="locationCode"/>
        <result column="sku_code" property="skuCode"/>
        <result column="client_code" property="clientCode"/>
        <result column="planned_count" property="plannedCount"/>
        <result column="moved_count" property="movedCount"/>
        <result column="damage_count" property="damageCount"/>
        <result column="operator_id" property="operatorId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <resultMap id="TaskVOMap" type="titan.wms.common.dao.meta.inside.vo.PlannedMoveTaskVO">
        <result column="id" property="id"/>
        <result column="planned_move_order_id" property="plannedMoveOrderId"/>
        <result column="status" property="status"/>
        <result column="location_code" property="locationCode"/>
        <result column="client_code" property="clientCode"/>
        <result column="sku_code" property="skuCode"/>
        <result column="sku_name" property="skuName"/>
        <result column="planned_count" property="plannedCount"/>
        <result column="moved_count" property="movedCount"/>
        <result column="damage_count" property="damageCount"/>
        <result column="operator_id" property="operatorId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="floor" property="floor"/>
        <result column="area" property="area"/>
        <result column="channel" property="channel"/>
        <result column="working_seq" property="workingSeq"/>
    </resultMap>

    <!--auto generated Code-->
    <sql id="all_column">
        `id`,
        <include refid="insert_column"/>
    </sql>

    <sql id="insert_column">
        `planned_move_order_id`,
        `status`,
        `location_code`,
        `client_code`,
        `sku_code`,
        `planned_count`,
        `moved_count`,
        `damage_count`,
        `operator_id`,
        `create_time`,
        `update_time`
    </sql>

    <sql id="table_name">
        `inside_planned_move_task`
    </sql>

    <!--auto generated Code-->
    <insert id="insert" useGeneratedKeys="true" keyProperty="pojo.id">
        INSERT INTO <include refid="table_name"/> (
            <include refid="insert_column"/>
        ) VALUES (
            #{pojo.plannedMoveOrderId},
            #{pojo.status},
            #{pojo.locationCode},
            #{pojo.clientCode},
            #{pojo.skuCode},
            #{pojo.plannedCount},
            #{pojo.movedCount},
            #{pojo.damageCount},
            #{pojo.operatorId},
            now(),
            now()
        )
    </insert>

    <!--auto generated Code-->
    <insert id="insertList">
        INSERT INTO <include refid="table_name"/> (
        <include refid="insert_column"/>
        )VALUES
        <foreach collection="pojos" item="pojo" index="index" separator=",">
            (
            #{pojo.plannedMoveOrderId},
            #{pojo.status},
            #{pojo.locationCode},
            #{pojo.clientCode},
            #{pojo.skuCode},
            #{pojo.plannedCount},
            #{pojo.movedCount},
            #{pojo.damageCount},
            #{pojo.operatorId},
            now(),
            now()
            )
        </foreach>
    </insert>

    <!--auto generated Code-->
    <update id="update">
        UPDATE <include refid="table_name"/>
        <set>
            <if test="pojo.status != null"> `status` = #{pojo.status}, </if>
            <if test="pojo.locationCode != null"> `location_code` = #{pojo.locationCode}, </if>
            <if test="pojo.clientCode != null"> `client_code` = #{pojo.clientCode}, </if>
            <if test="pojo.skuCode != null"> `sku_code` = #{pojo.skuCode}, </if>
            <if test="pojo.plannedCount != null"> `planned_count` = #{pojo.plannedCount}, </if>
            <if test="pojo.movedCount != null"> `moved_count` = #{pojo.movedCount}, </if>
            <if test="pojo.damageCount != null"> `damage_count` = #{pojo.damageCount}, </if>
            <if test="pojo.operatorId != null"> `operator_id` = #{pojo.operatorId}, </if>
            `update_time` = now()
        </set>
        WHERE id = #{pojo.id}
    </update>

    <select id="findExecutableTaskList" resultMap="TaskVOMap">
        select t.*
        ,l.`floor`,l.`area`,l.`channel`,l.`working_seq`

        from <include refid="table_name"/> t
        join basic_goods_location_master l on t.location_code = l.`code`
        where t.`planned_move_order_id` in
        <foreach collection="moveOrderIds" item="id" index="index" separator="," open="(" close=")">
            #{id}
        </foreach>
        and (
        t.`status` = #{newTaskStatus}
        or (t.`status` = #{executingTaskStatus} and t.`operator_id`=#{currentUserId})
        )
        order by t.location_code,t.id
    </select>

    <update id="updateStatusToExecuting">
        update <include refid="table_name"/>
        set `status` = #{executingTaskStatus},`operator_id` = #{currentUserId},update_time = now()
        where id = #{taskId}
        and (
        `status` = #{newTaskStatus}
        or (`status` = #{executingTaskStatus} and `operator_id`=#{currentUserId})
        )
    </update>

    <update id="updateAllTaskStatus">
        update <include refid="table_name"/>
        set `status` = #{status},update_time = now()
        where planned_move_order_id = #{moveOrderId}
    </update>

    <select id="countAll">
        select count(1)
        from <include refid="table_name"/>
        where planned_move_order_id = #{moveOrderId}
        <if test="status != null">
            and `status` = #{status}
        </if>
    </select>

    <select id="list" resultMap="AllColumnMap">
        select a.*
        ,b.sku_name
        from `inside_planned_move_task` a
        join `basic_sku_master` b on a.`sku_code` = b.`sku_code` and a.`client_code` = b.`client_code`
        where a.planned_move_order_id = #{moveOrderId}
        <if test="status != null">
            and a.`status` = #{status}
        </if>
        order by a.id desc limit #{limit} offset #{offset}
    </select>
</mapper>

